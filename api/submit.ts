// Vercel Serverless Function –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏
// 1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Vercel Postgres
// 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ AI (io.net)
// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email –∫–ª–∏–µ–Ω—Ç—É –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É

import type { VercelRequest, VercelResponse } from '@vercel/node';
import nodemailer from 'nodemailer';

// SMTP transporter
const transporter = nodemailer.createTransport({
  host: 'smtp.narod.ru',
  port: 465,
  secure: true,
  tls: { rejectUnauthorized: false },
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD,
  },
});

// io.net API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
async function generateExercisesWithAI(formData: any): Promise<string> {
  const apiKey = process.env.VITE_IO_NET_API_KEY || process.env.NET_API_KEY;
  const apiUrl = process.env.VITE_IO_NET_API_URL || 'https://api.intelligence.io.solutions/api/v1/chat/completions';
  const model = process.env.VITE_AI_MODEL || 'moonshotai/Kimi-K2-Instruct-0905';

  const conditionLabels: Record<string, string> = {
    stroke: '–ò–Ω—Å—É–ª—å—Ç',
    heart_attack: '–ò–Ω—Ñ–∞—Ä–∫—Ç',
    trauma: '–¢—Ä–∞–≤–º–∞',
    chronic: '–•—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ',
    other: '–î—Ä—É–≥–æ–µ',
  };

  const chronicLabels: Record<string, string> = {
    hypertension: '–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è',
    asthma: '–ê—Å—Ç–º–∞',
    diabetes: '–î–∏–∞–±–µ—Ç',
    other: '–î—Ä—É–≥–æ–µ',
  };

  const strokeSymptomLabels: Record<string, string> = {
    '–°–ª–∞–±–æ—Å—Ç—å –∏–ª–∏ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å —Ä—É–∫–∏': '–°–ª–∞–±–æ—Å—Ç—å —Ä—É–∫–∏',
    '–°–ª–∞–±–æ—Å—Ç—å –∏–ª–∏ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –Ω–æ–≥–∏': '–°–ª–∞–±–æ—Å—Ç—å –Ω–æ–≥–∏',
    '–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ–º / –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–µ–π': '–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ–º',
    '–ù–∞—Ä—É—à–µ–Ω–∏—è —Ä–µ—á–∏': '–ù–∞—Ä—É—à–µ–Ω–∏—è —Ä–µ—á–∏',
    '–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é / –≤–Ω–∏–º–∞–Ω–∏–µ–º': '–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é',
    '–ì–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏—è': '–ì–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏—è',
    '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω—Å—É–ª—å—Ç–∞': '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å',
    '–û–±—â–∞—è —Å–ª–∞–±–æ—Å—Ç—å, —É—Ç–æ–º–ª—è–µ–º–æ—Å—Ç—å': '–û–±—â–∞—è —Å–ª–∞–±–æ—Å—Ç—å',
  };

  const heartAttackSymptomLabels: Record<string, string> = {
    '–û–¥—ã—à–∫–∞ –ø—Ä–∏ –Ω–µ–±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ': '–û–¥—ã—à–∫–∞',
    '–°—Ç—Ä–∞—Ö —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏': '–°—Ç—Ä–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
    '–ë—ã—Å—Ç—Ä–∞—è —É—Ç–æ–º–ª—è–µ–º–æ—Å—Ç—å': '–ë—ã—Å—Ç—Ä–∞—è —É—Ç–æ–º–ª—è–µ–º–æ—Å—Ç—å',
    '–£—á–∞—â—ë–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ': '–£—á–∞—â—ë–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ',
    '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å, –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏': '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å',
    '–ù–∞—Ä—É—à–µ–Ω–∏—è —Å–Ω–∞': '–ù–∞—Ä—É—à–µ–Ω–∏—è —Å–Ω–∞',
    '–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ': '–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ',
    '–ë–æ–ª–∏ –≤ –≥—Ä—É–¥–∏ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ': '–ë–æ–ª–∏ –≤ –≥—Ä—É–¥–∏',
  };

  const traumaAreaLabels: Record<string, string> = {
    arm: '–†—É–∫–∞ / –ø–ª–µ—á–æ',
    leg: '–ù–æ–≥–∞ / –∫–æ–ª–µ–Ω–æ / –≥–æ–ª–µ–Ω–æ—Å—Ç–æ–ø',
    back: '–°–ø–∏–Ω–∞ / –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫',
    neck: '–®–µ—è',
    hip: '–¢–∞–∑–æ–±–µ–¥—Ä–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤',
    other: '–î—Ä—É–≥–æ–µ',
  };

  const prompt = `
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤—Ä–∞—á-—Ä–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. –°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å –∏–∑ 10-15 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞.

üìã –î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê:
- –ò–º—è: ${formData.clientName}
- –í–æ–∑—Ä–∞—Å—Ç: ${formData.age} –ª–µ—Ç
- –†–æ—Å—Ç: ${formData.height} —Å–º
- –í–µ—Å: ${formData.weight} –∫–≥
- –°–∏—Ç—É–∞—Ü–∏—è: ${formData.conditions}${formData.otherDetails ? ` (${formData.otherDetails})` : ''}
- –í—Ä–µ–º—è —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏—è: ${formData.timePassed}
${formData.chronicDiseases ? `- –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è: ${formData.chronicDiseases}${formData.chronicOtherDetails ? ` (${formData.chronicOtherDetails})` : ''}` : ''}
${formData.strokeSymptoms && formData.strokeSymptoms.length > 0 ? `- –°–∏–º–ø—Ç–æ–º—ã –ø–æ—Å–ª–µ –∏–Ω—Å—É–ª—å—Ç–∞: ${formData.strokeSymptoms.map((s: string) => strokeSymptomLabels[s] || s).join(', ')}` : ''}
${formData.heartAttackSymptoms && formData.heartAttackSymptoms.length > 0 ? `- –°–∏–º–ø—Ç–æ–º—ã –ø–æ—Å–ª–µ –∏–Ω—Ñ–∞—Ä–∫—Ç–∞: ${formData.heartAttackSymptoms.map((s: string) => heartAttackSymptomLabels[s] || s).join(', ')}` : ''}
${formData.traumaArea ? `- –û–±–ª–∞—Å—Ç—å —Ç—Ä–∞–≤–º—ã: ${traumaAreaLabels[formData.traumaArea] || formData.traumaArea}${formData.traumaOtherDetails ? ` (${formData.traumaOtherDetails})` : ''}` : ''}
- –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: ${formData.format}
${formData.comment ? `- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–∞—Ü–∏–µ–Ω—Ç–∞: ${formData.comment}` : ''}

üìù –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–û–ú–ü–õ–ï–ö–°–£:
1. –†–æ–≤–Ω–æ 10-15 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
2. –ö–∞–∂–¥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   - –ù–∞–∑–≤–∞–Ω–∏–µ
   - –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
   - –ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π (3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10-15 —Ä–∞–∑, –∏–ª–∏ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
   - –í–∞–∂–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –¥–ª—è –¥–æ–º–∞—à–Ω–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
4. –£—á–∏—Ç—ã–≤–∞–π –≤–æ–∑—Ä–∞—Å—Ç –∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
5. –í –Ω–∞—á–∞–ª–µ ‚Äî —Ä–∞–∑–º–∏–Ω–∫–∞ (3-5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π), –∑–∞—Ç–µ–º –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å, –≤ –∫–æ–Ω—Ü–µ ‚Äî –∑–∞–º–∏–Ω–∫–∞
6. –í—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

‚ö†Ô∏è –í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –æ—Å—Ç—Ä—ã–π –ø–µ—Ä–∏–æ–¥ (–º–µ–Ω–µ–µ 1 –º–µ—Å—è—Ü–∞) ‚Äî —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —â–∞–¥—è—â–∏–µ
- –ï—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç 70+ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —É–∫–∞–∑–∞–Ω–∏—è –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ–ø–æ—Ä—ã
- –ü—Ä–∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è—Ö ‚Äî –∏–∑–±–µ–≥–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π

üìÑ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –∫–æ–º–ø–ª–µ–∫—Å–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ (–±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤):

–ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ö–û–ú–ü–õ–ï–ö–° –£–ü–†–ê–ñ–ù–ï–ù–ò–ô
=================================
–ü–∞—Ü–∏–µ–Ω—Ç: [–ò–º—è]
–í–æ–∑—Ä–∞—Å—Ç: [–≤–æ–∑—Ä–∞—Å—Ç] –ª–µ—Ç
–î–∞—Ç–∞: [—Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞]

üìã –í–ê–®–ê –°–ò–¢–£–ê–¶–ò–Ø:
[–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏]

‚ö†Ô∏è –í–ê–ñ–ù–´–ï –£–ö–ê–ó–ê–ù–ò–Ø:
[–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è]

üî• –†–ê–ó–ú–ò–ù–ö–ê (5-7 –º–∏–Ω—É—Ç):
1. [–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è]
   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: [–æ–ø–∏—Å–∞–Ω–∏–µ]
   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: [–ø–æ—à–∞–≥–æ–≤–æ]
   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: [–∫–æ–ª-–≤–æ]
   
[–∏ —Ç–∞–∫ –¥–∞–ª–µ–µ...]

üìã –û–°–ù–û–í–ù–û–ô –ö–û–ú–ü–õ–ï–ö–°:
[–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è 4-12...]

üßò –ó–ê–ú–ò–ù–ö–ê –ò –†–ê–°–°–õ–ê–ë–õ–ï–ù–ò–ï:
[–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è 13-15...]

üí° –û–ë–©–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º –≤–æ –≤—Ä–µ–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
‚Ä¢ –ü—Ä–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ
‚Ä¢ –ó–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –ª—É—á—à–µ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è
‚Ä¢ –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–Ω—è—Ç–∏–π –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º

üìû –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: +7 (953) 790-20-10
`.trim();

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: model,
        messages: [
          {
            role: 'system',
            content: '–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤—Ä–∞—á-—Ä–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥. –°–æ—Å—Ç–∞–≤–ª—è–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–∏.',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        max_tokens: 4000,
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('AI API Error:', response.status, errorText);
      throw new Error(`AI API error: ${response.status} ${errorText}`);
    }

    const result = await response.json();
    const exercises = result.choices?.[0]?.message?.content?.trim();

    if (!exercises) {
      throw new Error('AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
    }

    return exercises;
  } catch (error: any) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', error);
    throw error;
  }
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // CORS
  const origin = req.headers.origin || '';
  res.setHeader('Access-Control-Allow-Origin', origin || '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const formData = req.body;
    console.log('üì• –ü–æ–ª—É—á–µ–Ω–∞ –∑–∞—è–≤–∫–∞ –æ—Ç:', formData.clientName, formData.clientEmail);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if (!formData.clientName || !formData.clientEmail || !formData.phone) {
      return res.status(400).json({ error: '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è' });
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–ø–ª–µ–∫—Å–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ AI
    console.log('ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ AI...');
    let exercisePlan: string;

    try {
      exercisePlan = await generateExercisesWithAI(formData);
      console.log('‚úÖ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã');
    } catch (aiError: any) {
      console.error('‚ùå –û—à–∏–±–∫–∞ AI, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:', aiError);
      // Fallback ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑ AI
      exercisePlan = generateFallbackRecommendations(formData);
    }

    // –ü–∏—Å—å–º–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    const clientMailOptions = {
      from: `"RehabApp" <${process.env.EMAIL_USER}>`,
      to: formData.clientEmail,
      subject: '–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–∏',
      text: `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${formData.clientName}!\n\n${exercisePlan}\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ö–æ–º–∞–Ω–¥–∞ RehabApp`,
      html: `
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            h1 { color: #16a34a; }
            h2 { color: #15803d; margin-top: 20px; }
            pre { background: #f5f5f5; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; }
            .header { background: linear-gradient(135deg, #16a34a, #22c55e); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
            .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #16a34a; color: #666; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>üåø RehabApp</h1>
            <p>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
          </div>
          <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${formData.clientName}!</h2>
          <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã. –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏–∏.</p>
          <pre>${exercisePlan.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <div class="footer">
            <p><strong>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ RehabApp</strong></p>
            <p>üìû +7 (953) 790-20-10</p>
            <p>‚ö†Ô∏è –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–Ω—è—Ç–∏–π –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º.</p>
          </div>
        </body>
        </html>
      `,
    };

    // –ü–∏—Å—å–º–æ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
    const instructorMailOptions = {
      from: `"RehabApp" <${process.env.EMAIL_USER}>`,
      to: 'rover38354@gmail.com',
      subject: `üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—é –æ—Ç ${formData.clientName}`,
      text: `
–ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê –ù–ê –†–ï–ê–ë–ò–õ–ò–¢–ê–¶–ò–Æ
============================

üë§ –ö–ª–∏–µ–Ω—Ç: ${formData.clientName}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${formData.phone}
‚úâÔ∏è Email: ${formData.clientEmail}

üìä –ê–Ω–∫–µ—Ç–∞:
- –í–æ–∑—Ä–∞—Å—Ç: ${formData.age} –ª–µ—Ç
- –†–æ—Å—Ç/–í–µ—Å: ${formData.height} —Å–º / ${formData.weight} –∫–≥
- –°–∏—Ç—É–∞—Ü–∏—è: ${formData.conditions}${formData.otherDetails ? ` ‚Äî ${formData.otherDetails}` : ''}
- –í—Ä–µ–º—è –ø—Ä–æ—à–ª–æ: ${formData.timePassed}
- –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è: ${formData.chronicDiseases || '–ù–µ—Ç'}${formData.chronicOtherDetails ? ` ‚Äî ${formData.chronicOtherDetails}` : ''}
- –§–æ—Ä–º–∞—Ç: ${formData.format}
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${formData.comment || '–ù–µ—Ç'}

üìã –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ö–û–ú–ü–õ–ï–ö–°:
${exercisePlan}
      `.trim(),
      html: `
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; }
            .header { background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px; }
            .info { background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
            pre { background: #f5f5f5; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
            .label { font-weight: bold; color: #374151; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h2>
          </div>
          <div class="info">
            <p><span class="label">–ò–º—è:</span> ${formData.clientName}</p>
            <p><span class="label">–¢–µ–ª–µ—Ñ–æ–Ω:</span> ${formData.phone}</p>
            <p><span class="label">Email:</span> ${formData.clientEmail}</p>
            <p><span class="label">–í–æ–∑—Ä–∞—Å—Ç:</span> ${formData.age} –ª–µ—Ç</p>
            <p><span class="label">–†–æ—Å—Ç/–í–µ—Å:</span> ${formData.height} —Å–º / ${formData.weight} –∫–≥</p>
            <p><span class="label">–°–∏—Ç—É–∞—Ü–∏—è:</span> ${formData.conditions}${formData.otherDetails ? ` ‚Äî ${formData.otherDetails}` : ''}</p>
            <p><span class="label">–í—Ä–µ–º—è –ø—Ä–æ—à–ª–æ:</span> ${formData.timePassed}</p>
            <p><span class="label">–§–æ—Ä–º–∞—Ç:</span> ${formData.format}</p>
          </div>
          <h3>üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å:</h3>
          <pre>${exercisePlan.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
        </body>
        </html>
      `,
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º
    console.log('üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º...');
    await Promise.all([
      transporter.sendMail(clientMailOptions),
      transporter.sendMail(instructorMailOptions),
    ]);

    console.log('‚úÖ –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');

    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Vercel Postgres
    // const { sql } = await import('@vercel/postgres');
    // await sql`INSERT INTO submissions (...) VALUES (...)`;

    return res.status(200).json({
      success: true,
      message: '–ó–∞—è–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã',
    });
  } catch (error: any) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏:', error);
    return res.status(500).json({
      error: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É',
    });
  }
}

// Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
function generateFallbackRecommendations(data: any): string {
  const conditions = data.conditions || '';
  const timePassed = data.timePassed || '';
  const age = parseInt(data.age) || 60;

  let rec: string[] = [];

  rec.push('–ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ö–û–ú–ü–õ–ï–ö–° –£–ü–†–ê–ñ–ù–ï–ù–ò–ô');
  rec.push('=================================');
  rec.push(`–ü–∞—Ü–∏–µ–Ω—Ç: ${data.clientName}`);
  rec.push(`–í–æ–∑—Ä–∞—Å—Ç: ${data.age} –ª–µ—Ç`);
  rec.push(`–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}`);
  rec.push('');
  rec.push('üìã –í–ê–®–ê –°–ò–¢–£–ê–¶–ò–Ø:');
  rec.push(`${conditions}${data.otherDetails ? ` ‚Äî ${data.otherDetails}` : ''}`);
  rec.push(`–í—Ä–µ–º—è —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏—è: ${timePassed}`);
  rec.push('');

  // –†–∞–∑–º–∏–Ω–∫–∞
  rec.push('üî• –†–ê–ó–ú–ò–ù–ö–ê (5-7 –º–∏–Ω—É—Ç):');
  rec.push('');
  rec.push('1. –î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
  rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°–∏–¥—è –∏–ª–∏ —Å—Ç–æ—è, —Å–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è');
  rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ì–ª—É–±–æ–∫–∏–π –≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å, –º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã–¥–æ—Ö —á–µ—Ä–µ–∑ —Ä–æ—Ç');
  rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 10-15 —Ä–∞–∑');
  rec.push('');
  rec.push('2. –ù–∞–∫–ª–æ–Ω—ã –≥–æ–ª–æ–≤—ã');
  rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°–∏–¥—è, —Ä—É–∫–∏ –Ω–∞ –∫–æ–ª–µ–Ω—è—Ö');
  rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –Ω–∞–∫–ª–æ–Ω—ã –≥–æ–ª–æ–≤—ã –≤–ø–µ—Ä—ë–¥-–Ω–∞–∑–∞–¥, –∑–∞—Ç–µ–º –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ');
  rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ 5-7 —Ä–∞–∑ –≤ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É');
  rec.push('');
  rec.push('3. –í—Ä–∞—â–µ–Ω–∏—è –≤ –ø–ª–µ—á–∞—Ö');
  rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è, –Ω–æ–≥–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á');
  rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ö—Ä—É–≥–æ–≤—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–ª–µ—á–∞–º–∏ –≤–ø–µ—Ä—ë–¥ –∏ –Ω–∞–∑–∞–¥');
  rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ 10 —Ä–∞–∑ –≤ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É');
  rec.push('');

  // –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏
  rec.push('üìã –û–°–ù–û–í–ù–û–ô –ö–û–ú–ü–õ–ï–ö–°:');
  rec.push('');

  if (conditions.includes('–ò–Ω—Å—É–ª—å—Ç') || conditions.includes('stroke')) {
    rec.push('4. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä—É–∫');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°–∏–¥—è –Ω–∞ —Å—Ç—É–ª–µ');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –°–∂–∏–º–∞–Ω–∏–µ –∏ —Ä–∞–∑–∂–∏–º–∞–Ω–∏–µ –∫—É–ª–∞–∫–æ–≤, –ø–æ–¥—ä—ë–º —Ä—É–∫ –≤–ø–µ—Ä—ë–¥');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 10-15 —Ä–∞–∑');
    rec.push('');
    rec.push('5. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –Ω–æ–≥');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°–∏–¥—è –Ω–∞ —Å—Ç—É–ª–µ');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ü–æ–¥—ä—ë–º –∫–æ–ª–µ–Ω–µ–π, –ø–µ—Ä–µ–∫–∞—Ç—ã —Å –ø—è—Ç–∫–∏ –Ω–∞ –Ω–æ—Å–æ–∫');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 10-15 —Ä–∞–∑');
    rec.push('');
    rec.push('6. –ë–∞–ª–∞–Ω—Å');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è —Å –æ–ø–æ—Ä–æ–π');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –°—Ç–æ—è–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π)');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ 10-15 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–∞–∂–¥—É—é –Ω–æ–≥—É');
  } else if (conditions.includes('–ò–Ω—Ñ–∞—Ä–∫—Ç') || conditions.includes('heart_attack')) {
    rec.push('4. –õ—ë–≥–∫–∞—è –∫–∞—Ä–¥–∏–æ–Ω–∞–≥—Ä—É–∑–∫–∞');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –•–æ–¥—å–±–∞ –Ω–∞ –º–µ—Å—Ç–µ —Å –≤—ã—Å–æ–∫–∏–º –ø–æ–¥–Ω–∏–º–∞–Ω–∏–µ–º –∫–æ–ª–µ–Ω');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 2-3 –º–∏–Ω—É—Ç—ã');
    rec.push('');
    rec.push('5. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä—É–∫');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è, –Ω–æ–≥–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ü–æ–¥—ä—ë–º —Ä—É–∫ –≤ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –æ–ø—É—Å–∫–∞–Ω–∏–µ');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 10-12 —Ä–∞–∑');
    rec.push('');
    rec.push('6. –ü–æ–ª—É–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è —Å –æ–ø–æ—Ä–æ–π –Ω–∞ —Å–ø–∏–Ω–∫—É —Å—Ç—É–ª–∞');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è –Ω–∞ 1/4 –∞–º–ø–ª–∏—Ç—É–¥—ã');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 8-10 —Ä–∞–∑');
  } else if (conditions.includes('–¢—Ä–∞–≤–º–∞') || conditions.includes('trauma')) {
    rec.push('4. –õ—ë–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°–∏–¥—è –∏–ª–∏ –ª—ë–∂–∞');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ –º—ã—à—Ü –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∞–º–ø–ª–∏—Ç—É–¥–µ');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å 15-20 —Å–µ–∫—É–Ω–¥');
    rec.push('');
    rec.push('5. –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –£–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –º—ã—à—Ü –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è –≤ —Å—É—Å—Ç–∞–≤–µ');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 5-7 —Å–µ–∫—É–Ω–¥ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è, 10 —Å–µ–∫—É–Ω–¥ –æ—Ç–¥—ã—Ö–∞');
    rec.push('');
    rec.push('6. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∑—ã');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –° –æ–ø–æ—Ä–æ–π');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 15-30 —Å–µ–∫—É–Ω–¥');
  } else {
    rec.push('4. –ú—è–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è –∏–ª–∏ —Å–∏–¥—è');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ù–∞–∫–ª–æ–Ω—ã –∫–æ—Ä–ø—É—Å–∞, –≤—Ä–∞—â–µ–Ω–∏—è –≤ —Å—É—Å—Ç–∞–≤–∞—Ö');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ 8-10 —Ä–∞–∑');
    rec.push('');
    rec.push('5. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä–∞');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –õ—ë–∂–∞ –Ω–∞ —Å–ø–∏–Ω–µ');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ü–æ–¥—ä—ë–º —Ç–∞–∑–∞, —É–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –ø—Ä–µ—Å—Å–∞');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 8-10 —Ä–∞–∑');
    rec.push('');
    rec.push('6. –ë–∞–ª–∞–Ω—Å –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è');
    rec.push('   –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –°—Ç–æ—è —Å –æ–ø–æ—Ä–æ–π');
    rec.push('   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –°—Ç–æ—è–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ, –ø–µ—Ä–µ–Ω–æ—Å –≤–µ—Å–∞');
    rec.push('   –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –ø–æ 10-15 —Å–µ–∫—É–Ω–¥');
  }

  // –ó–∞–º–∏–Ω–∫–∞
  rec.push('');
  rec.push('üßò –ó–ê–ú–ò–ù–ö–ê –ò –†–ê–°–°–õ–ê–ë–õ–ï–ù–ò–ï:');
  rec.push('');
  rec.push('12. –ì–ª—É–±–æ–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ');
  rec.push('    –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –õ—ë–∂–∞ –∏–ª–∏ —Å–∏–¥—è –≤ —É–¥–æ–±–Ω–æ–π –ø–æ–∑–µ');
  rec.push('    –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –¥–∏–∞—Ñ—Ä–∞–≥–º–∞–ª—å–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ');
  rec.push('    –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: 2-3 –º–∏–Ω—É—Ç—ã');
  rec.push('');
  rec.push('13. –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è');
  rec.push('    –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –õ—ë–∂–∞ –Ω–∞ —Å–ø–∏–Ω–µ');
  rec.push('    –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –º—ã—à—Ü');
  rec.push('    –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: –æ—Ç –Ω–æ–≥ –∫ –≥–æ–ª–æ–≤–µ, –ø–æ 5 —Å–µ–∫—É–Ω–¥');
  rec.push('');
  rec.push('14-15. –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –≤—Å–µ—Ö –≥—Ä—É–ø–ø –º—ã—à—Ü');
  rec.push('    –ò—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –£–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ');
  rec.push('    –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –ü–ª–∞–≤–Ω–æ–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π 20-30 —Å–µ–∫—É–Ω–¥');
  rec.push('');

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
  rec.push('‚ö†Ô∏è –í–ê–ñ–ù–´–ï –£–ö–ê–ó–ê–ù–ò–Ø:');
  if (timePassed.includes('–û—Å—Ç—Ä—ã–π') || timePassed.includes('acute') || timePassed.includes('1 –º–µ—Å—è—Ü–∞')) {
    rec.push('- –í –æ—Å—Ç—Ä—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–Ω–∏–º–∞–π—Ç–µ—Å—å –¢–û–õ–¨–ö–û –ø–æ–¥ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º –≤—Ä–∞—á–∞!');
  }
  if (age > 70) {
    rec.push('- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–æ—Ä—É –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π');
    rec.push('- –î–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç');
  }
  rec.push('- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏');
  rec.push('- –ü—Ä–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ');
  rec.push('');

  rec.push('üí° –û–ë–©–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:');
  rec.push('‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏');
  rec.push('‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º –≤–æ –≤—Ä–µ–º—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π');
  rec.push('‚Ä¢ –ü—Ä–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ');
  rec.push('‚Ä¢ –ó–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –ª—É—á—à–µ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è');
  rec.push('');
  rec.push('üìû –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: +7 (953) 790-20-10');

  return rec.join('\n');
}
